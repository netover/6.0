# Arquitetura do Resync v6.2.0

## Visão Geral da Arquitetura

O Resync é uma plataforma de orquestração de agentes AI построенный sobre uma arquitetura modular em camadas:

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         FastAPI Application                              │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │ │
│  │  │  Routes  │  │   Auth   │  │  Cache   │  │  Middle  │              │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                           SERVICE LAYER                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ LLM Service │  │TWS Service │  │RAG Client  │  │ Auth Svc   │        │
│  │             │  │            │  │             │  │             │        │
│  │ - OpenAI    │  │ - IBM TWS  │  │ - Retrieval │  │ - JWT      │        │
│  │ - Anthropic │  │ - Jobs     │  │ - Embeddings│  │ - Sessions │        │
│  │ - LiteLLM  │  │ - Workst.  │  │ - Vector DB │  │ - OAuth    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                          AGENT LAYER (LangGraph)                              │
│                                                                                │
│    ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐     │
│    │  Router  │─────▶│Clarify   │─────▶│ Planner  │─────▶│Executor │     │
│    │  Node    │      │  Node    │      │  Node    │      │  Node   │     │
│    └──────────┘      └──────────┘      └──────────┘      └──────────┘     │
│         │                                                 │                   │
│         │         ┌──────────────────────────────────────┘                   │
│         │         ▼                                                           │
│         │    ┌──────────┐      ┌──────────┐      ┌──────────┐              │
│         └───▶│Synthesiz │◀─────│  Query   │◀─────│  Action  │              │
│              │  Node    │      │  Node    │      │  Node    │              │
│              └──────────┘      └──────────┘      └──────────┘              │
│                   │                                                       │
│                   ▼                                                       │
│              ┌──────────┐                                                  │
│              │Hallucinat│                                                  │
│              │  Grader  │                                                  │
│              └──────────┘                                                  │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                          KNOWLEDGE LAYER                                      │
│                                                                                │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │ Ingestion    │───▶│  Retrieval   │───▶│   Storage    │                   │
│  │              │    │              │    │              │                   │
│  │ - Chunking   │    │ - Semantic   │    │ - PgVector  │                   │
│  │ - Embeddings │    │ - Hybrid     │    │ - Knowledge │                   │
│  │ - Parsing    │    │ - Rerank    │    │   Graph     │                   │
│  └──────────────┘    └──────────────┘    └──────────────┘                   │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                            DATA LAYER                                          │
│                                                                                │
│  ┌─────────────────────────────┐      ┌─────────────────────────────────────┐  │
│  │       PostgreSQL            │      │            Redis                    │  │
│  │                             │      │                                     │  │
│  │  ┌─────────────────────┐   │      │  ┌─────────────────────────────┐   │  │
│  │  │ Tables              │   │      │  │ Caches                      │   │  │
│  │  │ - users            │   │      │  │ - LLM Response Cache        │   │  │
│  │  │ - audit_logs       │   │      │  │ - Query Results             │   │  │
│  │  │ - tws_snapshots    │   │      │  │ - Session Data              │   │  │
│  │  │ - conversations     │   │      │  │                             │   │  │
│  │  │ - kg_nodes/edges   │   │      │  └─────────────────────────────┘   │  │
│  │  │ - metrics          │   │      │  ┌─────────────────────────────┐   │  │
│  │  └─────────────────────┘   │      │  │ Structures                  │   │  │
│  │  ┌─────────────────────┐   │      │  │ - Rate Limiting            │   │  │
│  │  │ Extensions          │   │      │  │ - Idempotency Keys         │   │  │
│  │  │ - pgvector         │   │      │  │ - Circuit Breaker State    │   │  │
│  │  │ - pg_trgm          │   │      │  └─────────────────────────────┘   │  │
│  │  └─────────────────────┘   │      │                                     │  │
│  └─────────────────────────────┘      └─────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## Fluxo de Dados

### Fluxo 1: Chat com Agente

```
User Message
     │
     ▼
┌─────────────────┐
│   API Route     │
│  /chat endpoint │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Auth Middleware│
│ (JWT Validate) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ Router Node     │────▶│ Intent         │
│ (Classify)      │     │ Classification │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │    ┌──────────────────┘
         │    ▼
         │ ┌─────────────────┐     ┌─────────────────┐
         ├─▶│ Clarify Node  │────▶│ Missing Entity? │
         │ │ (If needed)    │ Yes │                 │
         │ └─────────────────┘     └────────┬────────┘
         │                                  │ No
         │                                  ▼
         │ ┌─────────────────┐     ┌─────────────────┐
         ├─▶│ Query Handler  │────▶│ RAG Retrieval  │
         │ │ (RAG only)     │     │ (Vector Search)│
         │ └─────────────────┘     └────────┬────────┘
         │                                  │
         │    ┌─────────────────────────────┘
         │    ▼
         │ ┌─────────────────┐     ┌─────────────────┐
         ├─▶│ Action Handler │────▶│ TWS API Call   │
         │ │ (TWS actions)   │     │ (Job/Workst.)   │
         │ └─────────────────┘     └────────┬────────┘
         │                                  │
         │    ┌─────────────────────────────┘
         │    ▼
         │ ┌─────────────────┐     ┌─────────────────┐
         ├─▶│ Synthesizer   │────▶│ LLM Compose    │
         │ │ (Final Answer) │     │ Response       │
         │ └─────────────────┘     └────────┬────────┘
         │                                  │
         │    ┌─────────────────────────────┘
         │    ▼
         │ ┌─────────────────┐     ┌─────────────────┐
         ├─▶│ Hallucination  │────▶│ Validate        │
         │ │ Grader         │     │ Response        │
         │ └─────────────────┘     └────────┬────────┘
         │                                  │
         ▼                                  ▼
   Response to User              (If hallucination, retry)
```

### Fluxo 2: Ingestão de Documentos

```
Document Upload
     │
     ▼
┌─────────────────┐
│ API Route       │
│ /rag/upload     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ Document        │────▶│ Parse Document │
│ Converter       │     │ (PDF, MD, etc) │
└─────────────────┘     └────────┬────────┘
                                 │
                                 ▼
┌─────────────────┐     ┌─────────────────┐
│ Chunking        │────▶│ Split into     │
│ Strategy        │     │ Chunks         │
└─────────────────┘     └────────┬────────┘
                                 │
                                 ▼
┌─────────────────┐     ┌─────────────────┐
│ Embedding       │────▶│ Generate        │
│ Service         │     │ Embeddings      │
└─────────────────┘     └────────┬────────┘
                                 │
                                 ▼
┌─────────────────┐     ┌─────────────────┐
│ Vector Store   │────▶│ Store in        │
│ (PgVector)     │     │ PostgreSQL      │
└─────────────────┘     └─────────────────┘
```

---

## Componentes Principais

### 1. LangGraph Agent

O agente principal baseado em LangGraph:

```
┌─────────────────────────────────────────────────────────────────┐
│                    LANGGRAPH AGENT FLOW                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   START ──────▶ ┌─────────────┐                                │
│                │   Router    │                                │
│                │   Node      │                                │
│                └──────┬──────┘                                │
│                       │                                        │
│          ┌────────────┼────────────┐                          │
│          │            │            │                          │
│          ▼            ▼            ▼                          │
│    ┌──────────┐ ┌──────────┐ ┌──────────┐                  │
│    │ Status   │ │ Troublesh│ │ Action   │                  │
│    │ Handler  │ │ Handler  │ │ Handler  │                  │
│    └────┬─────┘ └────┬─────┘ └────┬─────┘                  │
│         │            │            │                          │
│         └─────────────┼────────────┘                          │
│                       ▼                                       │
│                ┌─────────────┐                                │
│                │  Planner    │                                │
│                │   Node      │                                │
│                └──────┬──────┘                                │
│                       │                                        │
│                       ▼                                        │
│                ┌─────────────┐                                │
│                │   Executor  │                                │
│                │   Node      │                                │
│                └──────┬──────┘                                │
│                       │                                        │
│                       ▼                                        │
│                ┌─────────────┐                                │
│                │ Synthesizer │                                │
│                │   Node      │                                │
│                └──────┬──────┘                                │
│                       │                                        │
│                       ▼                                        │
│                ┌─────────────┐                                │
│                │ Hallucinat. │                                │
│                │   Grader    │                                │
│                └──────┬──────┘                                │
│                       │                                        │
│                       ▼                                        │
│                      END                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Sistema de Cache

Arquitetura de cache em múltiplas camadas:

```
┌─────────────────────────────────────────────────────────────┐
│                    CACHE HIERARCHY                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              L1: In-Memory Cache                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ - LRU Cache (functools)                     │    │   │
│  │  │ - Semantic Cache (embeddings)               │    │   │
│  │  │ - Query Result Cache                         │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └──────────────────────────┬────────────────────────────┘   │
│                             │                                  │
│                             ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              L2: Redis Cache                         │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ - Distributed Cache                          │    │   │
│  │  │ - Session Store                              │    │   │
│  │  │ - Rate Limiting                             │    │   │
│  │  │ - Idempotency Keys                          │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └──────────────────────────┬────────────────────────────┘   │
│                             │                                  │
│                             ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              L3: PostgreSQL                         │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ - Persistent Cache                           │    │   │
│  │  │ - Audit Logs                                │    │   │
│  │  │ - Knowledge Graph                           │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 3. Sistema de Monitoramento

```
┌─────────────────────────────────────────────────────────────┐
│                 MONITORING STACK                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  Dashboard   │  │    Sentry    │  │   Langfuse   │    │
│  │  Interno     │  │  (Errors)    │  │(LLM Observab)│    │
│  │  (Redis)    │  └──────┬───────┘  └──────┬───────┘    │
│  └──────┬───────┘         │                  │             │
│         │                  │                  │             │
│         ▼                  └──────────────────┼─────────────┘
│  ┌──────────────┐                                 ▼          │
│  │  WebSocket   │                      ┌──────────────────┐ │
│  │  Streaming   │                      │   Structlog      │ │
│  └──────────────┘                      │   (Logging)      │ │
│                                       └──────────────────┘ │
│                                                              │
│  Obs: Substitui Prometheus/Grafana com solução Redis       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Tabelas do Banco de Dados

### Entidades Principais

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATABASE SCHEMA                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  USERS & AUTH                                                              │
│  ┌─────────┐     ┌──────────────┐     ┌────────────────┐                  │
│  │  users  │────▶│user_profiles │     │session_history │                  │
│  └────┬────┘     └──────────────┘     └────────────────┘                  │
│       │                                                                    │
│       │     ┌──────────────┐                                               │
│       └────▶│ audit_logs   │                                               │
│             └──────────────┘                                               │
│                                                                             │
│  TWS (IBM Tivoli)                                                         │
│  ┌────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │tws_snapshots   │  │tws_job_status   │  │tws_workstation  │             │
│  │                │  │                 │  │_status          │             │
│  └───────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
│          │                    │                    │                        │
│          └────────────────────┼────────────────────┘                        │
│                               ▼                                            │
│  ┌─────────────┐  ┌────────────────┐  ┌──────────────┐                    │
│  │tws_events   │  │tws_patterns    │  │tws_problem   │                    │
│  │             │  │                │  │_solutions    │                    │
│  └─────────────┘  └────────────────┘  └──────────────┘                    │
│                                                                             │
│  KNOWLEDGE & RAG                                                           │
│  ┌──────────────┐  ┌────────────────┐  ┌────────────────┐                  │
│  │ kg_nodes     │  │kg_edges        │  │feedback        │                  │
│  │              │  │                │  │                │                  │
│  └──────────────┘  └────────────────┘  └────────────────┘                  │
│                                                                             │
│  METRICS                                                                   │
│  ┌────────────────────────┐  ┌─────────────────────────┐                  │
│  │workstation_metrics    │  │metric_data_points       │                  │
│  │_history               │  │                         │                  │
│  └────────────────────────┘  └─────────────────────────┘                  │
│                                                                             │
│  TEAMS INTEGRATION                                                         │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │teams_channels │  │teams_job      │  │teams_notification│             │
│  │               │  │_mappings      │  │_log            │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Security

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SECURITY LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        AUTHENTICATION                                │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │    JWT      │  │   OAuth2    │  │   API Key   │                │   │
│  │  │  (Bearer)   │  │  (External) │  │  (Admin)    │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        AUTHORIZATION                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │   RBAC     │  │  Permissions│  │   Teams     │                │   │
│  │  │  (Roles)   │  │   (Scopes)  │  │  (Groups)   │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        PROTECTION                                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │  Rate       │  │   CORS      │  │    CSP      │                │   │
│  │  │  Limiting   │  │  Headers    │  │  Headers    │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │   CSRF      │  │  Idempotency│  │  Circuit    │                │   │
│  │  │  Protection │  │   Keys      │  │  Breaker   │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Configuração de Ambiente

### Variáveis de Ambiente

```bash
# Database
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/db

# Redis
REDIS_URL=redis://host:6379/0

# Auth
AUTH_SECRET_KEY=your-secret-key
AUTH_ALGORITHM=HS256

# LLM Providers
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...

# LangGraph
LANGGRAPH_ENABLED=true
LANGGRAPH_CHECKPOINT_TTL_HOURS=24
```

---

## Glossário

| Termo | Descrição |
|--------|-----------|
| **RAG** | Retrieval Augmented Generation - técnica de AI que combina busca com geração |
| **LangGraph** | Framework para criar agentes AI stateful |
| **TWS** | IBM Tivoli Workload Scheduler - sistema de agendamento de jobs |
| **Vector Store** | Banco de dados para embeddings (PgVector) |
| **Circuit Breaker** | Pattern para evitar falhas em cascata |
| **Idempotency** | Garantia de que requests repetidos têm o mesmo efeito |
| **Checkpointer** | Persistência de estado do agente LangGraph |
