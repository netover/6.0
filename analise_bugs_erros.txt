# Relatório sequencial de bugs, erros e propostas de solução

## Arquivo 001: `analyze_pr_comments.py`

### Bugs/erros encontrados
1. **Tratamento de exceção genérico (`except Exception`) ocultando causa real**
   - Risco: dificulta diagnóstico e mascara erros de tipo/estrutura no JSON.
   - Correção aplicada: substituído por validações explícitas + captura específica de `json.JSONDecodeError`.

2. **Acesso direto a chaves aninhadas (`comment['author']['login']`)**
   - Risco: `KeyError` quando payload vier incompleto.
   - Correção aplicada: adicionado acesso seguro com fallback (`unknown`).

3. **Falta de validação estrutural do JSON carregado**
   - Risco: quebra em runtime caso o conteúdo não seja objeto com listas em `comments/reviews`.
   - Correção aplicada: validação de tipo para raiz do JSON e para os campos `comments` e `reviews`.

4. **Leitura de arquivo sem validação de existência**
   - Risco: stack trace para ausência de `pr_comments.json`.
   - Correção aplicada: verificação antecipada de existência e retorno com código de erro 1.

5. **Script sem função `main` e sem código de saída explícito**
   - Risco: menor testabilidade e ausência de semântica clara de sucesso/erro em CI.
   - Correção aplicada: extraída função `main()` com retorno inteiro e `SystemExit` no bloco `if __name__ == '__main__'`.

6. **`sys.stdout.reconfigure` sem compatibilidade defensiva**
   - Risco: falha em ambientes onde `stdout` não suporta `reconfigure`.
   - Correção aplicada: adicionado helper `_safe_stdout_utf8()` com `hasattr`.

### Resultado
- Script ficou resiliente para payload parcial, erro de estrutura e ausência de arquivo.
- Fluxo de erro/sucesso agora é determinístico para automação.

---

> Próximo arquivo da sequência: pendente.

## Batch 002–101 (análise em lote de 100 arquivos Python)

### Escopo do lote
- Do arquivo `002 apply_fixes_ast.py` até `101 resync/api/routes/system/__init__.py`.
- Método aplicado sem instalação de novas bibliotecas: compilação sintática + varredura estática por padrões de risco comuns.

### Achados do lote
1. **Sem erros de sintaxe no lote (100/100 compilam)**
   - Evidência: execução de `py_compile` para todos os 100 arquivos.
   - Ação: manter.

2. **Uso recorrente de `except Exception` (50 arquivos do lote)**
   - Risco: reduz observabilidade e pode mascarar falhas de lógica/integração.
   - Proposta de correção em ondas:
     - Onda A (alta prioridade): rotas API e middlewares críticos.
     - Onda B: módulos utilitários e scripts.
     - Substituir por exceções específicas por camada (`ValueError`, `KeyError`, `HTTPException`, erros de cliente HTTP/DB etc.).

3. **Uso de `print()` em scripts utilitários (`apply_fixes_ast.py`, `auto_refactor.py`)**
   - Risco: logging inconsistente em execução automatizada.
   - Proposta: migrar para logger estruturado quando esses scripts forem promovidos para pipelines formais.

### Ajustes aplicados no plano CPU-only (dependências)
4. **Torch fixado para wheel CPU via index URL**
   - Correção aplicada em `requirements.txt`:
     - adicionado `--extra-index-url https://download.pytorch.org/whl/cpu`
     - ajustado `torch` para `torch==2.5.1+cpu`
   - Mantidos conforme instrução: `sentence-transformers`, `litellm`, `asyncpg`.

### Próximo lote
- Batch 102–201 (100 arquivos seguintes).

## Correções efetivamente aplicadas (além do relatório)

### Arquivo: `resync/api/middleware/__init__.py`
- Problema: captura genérica em import opcional (`except Exception`) mascarava erros reais do módulo.
- Correção aplicada: captura restrita para `ImportError`, mantendo fail-fast para outros erros de programação.

### Arquivo: `resync/api/routes/core/health.py`
- Problema 1: `HTTPException` era capturada por blocos genéricos em múltiplos endpoints, podendo sobrescrever detalhes de erro intencionais.
- Correção aplicada: adicionado `except HTTPException: raise` antes dos blocos genéricos em endpoints de health/readiness/liveness/recovery/redis.
- Problema 2: repetição de tupla de erros de programação em vários pontos.
- Correção aplicada: extraída constante `PROGRAMMING_ERRORS` para reduzir duplicação e risco de divergência.
- Problema 3: captura redundante de métricas com `except (..., Exception)`.
- Correção aplicada: removida redundância, mantendo captura específica (`AttributeError`, `ImportError`).

### Arquivo: `resync/api/security/__init__.py`
- Problema: `HTTPException` levantada dentro de `decode_token` poderia ser reempacotada pelo `except Exception` final.
- Correção aplicada: adicionado `except HTTPException: raise` para preservar status/detail originais.

## Batch 102–201 (análise em lote de 100 arquivos Python)
- Verificação de compilação sintática: 100/100 arquivos compilam.
- Próxima onda: reduzir `except Exception` em módulos de segurança, rotas system e cache core.

## Batch 202–301 (análise em lote de 100 arquivos Python)

### Correções aplicadas no código (não apenas registro)

1. **`resync/core/database/repositories/base.py`**
   - Problema: `execute_raw()` usava `except Exception` para caminho normal de queries sem result set.
   - Correção: substituído por `except ResourceClosedError` (exceção específica do SQLAlchemy para operações sem linhas de retorno).
   - Ganho: evita mascarar erros reais de programação/SQL ao mesmo tempo em que mantém o comportamento para DML.

2. **`resync/core/database/schema.py`**
   - Problema: criação de schemas e health check de conexão capturavam exceções genéricas.
   - Correção: captura restrita para `SQLAlchemyError` nos dois pontos.
   - Ganho: falhas não relacionadas ao driver/ORM voltam a emergir corretamente.

3. **`resync/core/distributed_tracing.py`**
   - Problema: import opcional de OpenTelemetry capturava `Exception` em bloco global.
   - Correção: troca para `except ImportError`.
   - Ganho: preserva degradação opcional quando pacote não existe, sem suprimir erros internos inesperados.

4. **`resync/core/database/engine.py`**
   - Problema: `close_engine()` capturava `Exception` ao fechar engine.
   - Correção: captura restrita para `SQLAlchemyError`.
   - Ganho: problemas de lógica fora do ciclo de SQLAlchemy não ficam mascarados.

### Validação do lote
- Compilação sintática do batch 202–301: **100/100** arquivos compilam.
- Pendência planejada: reduzir progressivamente os `except Exception` restantes do lote (191 ocorrências) em ondas por criticidade.
