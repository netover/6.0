# Projeto resync: Relatório de Bugs Críticos

Este relatório detalha os bugs críticos, regressões de API e riscos arquiteturais identificados durante a análise sistemática do codebase.

## 1. Bugs que Impedem a Inicialização (Impacto: Bloqueante)

### 1.1 Mismatch de Assinatura em `EncryptedAuditTrail.start()`
**Localização:** [manager.py:L426](file:///d:/Python/GITHUB/resync/6.0-new1/resync/core/enterprise/manager.py#L426) vs [encrypted_audit.py:L399](file:///d:/Python/GITHUB/resync/6.0-new1/resync/core/encrypted_audit.py#L399)

**Descrição:** Recentemente, a assinatura do método `start()` em `EncryptedAuditTrail` foi alterada para não aceitar argumentos. No entanto, o `EnterpriseManager` ainda tenta passar um `asyncio.TaskGroup` (`tg=tg`) para este método.
**Consequência:** `TypeError: start() got an unexpected keyword argument 'tg'`. O sistema falhará ao tentar inicializar os módulos de compliance se o `encrypted_audit` estiver habilitado.

---

## 2. Inconsistência de Concorrência Estruturada (Impacto: Alto/Risco de Dados)

### 2.1 Tarefas "Órfãs" no `OrchestrationRunner`
**Localização:** [runner.py:L83](file:///d:/Python/GITHUB/resync/6.0-new1/resync/core/orchestration/runner.py#L83)

**Descrição:** O `OrchestrationRunner` utiliza `asyncio.create_task` para disparar o loop de execução de workflows em background. Diferente de outros serviços que foram migrados para `asyncio.TaskGroup`, estas tarefas não são rastreadas centralmente.
**Consequência:** Ao desligar a aplicação (shutdown), estas tarefas serão canceladas abruptamente pelo loop sem que o sistema espere por seu encerramento gracioso. Isso pode deixar execuções de workflows presas no estado "in_progress" e causar inconsistências no banco de dados.

### 2.2 Reintrodução de `track_task` em `EncryptedAuditTrail`
**Localização:** [encrypted_audit.py:L416-418](file:///d:/Python/GITHUB/resync/6.0-new1/resync/core/encrypted_audit.py#L416-418)

**Descrição:** Embora o projeto esteja em transição para `asyncio.TaskGroup` (concorrência estruturada), a última atualização do `EncryptedAuditTrail` voltou a utilizar o sistema legado `track_task`.
**Consequência:** Dificulta a centralização do gerenciamento do ciclo de vida das tarefas e impede que falhas em workers de auditoria propaguem corretamente para o `TaskGroup` global em `startup.py`.

---

## 3. Riscos de Performance e Recursos (Impacto: Médio)

### 3.1 Utilização de `list` em vez de `deque` para Buffer de Auditoria
**Localização:** [encrypted_audit.py:L345](file:///d:/Python/GITHUB/resync/6.0-new1/resync/core/encrypted_audit.py#L345)

**Descrição:** O buffer de entradas pendentes foi alterado de `deque` (com `maxlen`) para uma `list` simples. Embora haja um check manual de tamanho em `log_event`, a remoção de elementos via `clear()` após o flush é menos eficiente sob carga extrema do que a garantia nativa de um `deque`.
**Risco:** Em cenários de erro de flush persistente, a lista pode crescer desnecessariamente se os mecanismos de retry não forem robustos.

---

## 4. Recomendações de Correção

1. **Sincronizar API Compliance**: Atualizar `EnterpriseManager` para não passar `tg` para `EncryptedAuditTrail`, ou restaurar o suporte a `tg` opcional no `EncryptedAuditTrail`.
2. **Global TaskGroup no Runner**: Passar o `bg_tasks` do lifespan para o `OrchestrationRunner` para que ele use `tg.create_task` em vez de `asyncio.create_task`.
3. **Consolidar Shutdown**: Garantir que o `_shutdown_services` em `startup.py` aguarde explicitamente pelo encerramento do `TaskGroup` global antes de fechar conexões de banco de dados.

---

*Relatório gerado em 21/02/2026 por Antigravity (Advanced Agentic Coding).*
