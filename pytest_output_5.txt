============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: D:\Python\GITHUB\resync\6.0
plugins: anyio-4.11.0, hypothesis-6.140.2, locust-2.41.2, asyncio-1.2.0, benchmark-5.1.0, cov-7.0.0, mock-3.15.1, timeout-2.4.0, xdist-3.8.0, respx-0.22.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 35 items

resync\tests\test_database_security.py .....F..........F...FF...F.....   [ 88%]
resync\tests\test_ui_smoke.py .F                                         [ 94%]
resync\tests\test_request_scope_isolation.py .F                          [100%]

================================== FAILURES ===================================
_____ TestDatabaseInputValidator.test_validate_string_input_invalid_cases _____

self = <resync.tests.test_database_security.TestDatabaseInputValidator object at 0x000001FCE2D1E8B0>

    def test_validate_string_input_invalid_cases(self):
        """Test invalid string inputs."""
        invalid_cases = [
            (None, "String input cannot be None"),
            (123, "Input must be string"),
            ("a" * 10001, "String input too long"),
            ("text with \x00 null byte", "String input cannot contain null bytes"),
            ("'; DROP TABLE users; --", "Dangerous pattern detected"),
            ("' OR '1'='1", "Dangerous pattern detected"),
        ]
    
        for input_text, expected_error in invalid_cases:
>           with pytest.raises(DatabaseSecurityError, match=expected_error):
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           Failed: DID NOT RAISE <class 'resync.core.database_security.DatabaseSecurityError'>

resync\tests\test_database_security.py:113: Failed
______ TestSQLInjectionMiddleware.test_sql_injection_detection_patterns _______

self = <resync.tests.test_database_security.TestSQLInjectionMiddleware object at 0x000001FCE2D51090>
mock_request = <class 'resync.tests.test_database_security.TestSQLInjectionMiddleware.mock_request.<locals>.MockRequest'>

    def test_sql_injection_detection_patterns(self, mock_request):
        """Test SQL injection pattern detection."""
        injection_patterns = [
            ("'; DROP TABLE users; --", True),
            ("' OR '1'='1", True),
            ("' UNION SELECT * FROM users --", True),
            ("; EXEC xp_cmdshell('dir') --", True),
            ("'; WAITFOR DELAY '00:00:05' --", True),
            ("' AND 1=CONVERT(int, (SELECT @@version)) --", True),
        ]
    
        middleware = DatabaseSecurityMiddleware(None, enabled=True)
    
        for injection_attempt, should_detect in injection_patterns:
            request = mock_request(query_params={"id": injection_attempt})
    
            if should_detect:
>               with pytest.raises(Exception):  # HTTPException
                     ^^^^^^^^^^^^^^^^^^^^^^^^
E               Failed: DID NOT RAISE <class 'Exception'>

resync\tests\test_database_security.py:291: Failed
------------------------------ Captured log call ------------------------------
WARNING  resync.core.database_security:database_security.py:373 database_security_violation
______ TestAuditRecordValidation.test_validate_audit_record_valid_cases _______

self = <resync.tests.test_database_security.TestAuditRecordValidation object at 0x000001FCE2D51310>

    def test_validate_audit_record_valid_cases(self):
        """Test valid audit record inputs."""
        valid_records = [
            {
                "id": "test_id_123",
                "user_query": "What is the weather today?",
                "agent_response": "The weather is sunny with a high of 75░F.",
                "ia_audit_reason": None,
                "ia_audit_confidence": None,
                "action": "QUERY",
            },
            {
                "id": "test_id_456",
                "user_query": "How do I reset my password?",
                "agent_response": "You can reset your password by clicking the forgot password link.",
                "ia_audit_reason": "Suspicious query pattern",
                "ia_audit_confidence": 0.85,
                "action": "RESET_PASSWORD",
            },
        ]
    
        for record in valid_records:
            result = _validate_audit_record(record)
>           assert result is True
E           AssertionError: assert {'action': 'QUERY', 'agent_response': 'The weather is sunny with a high of 75░F.', 'ia_audit_confidence': None, 'ia_audit_reason': None, ...} is True

resync\tests\test_database_security.py:375: AssertionError
_____ TestAuditRecordValidation.test_validate_audit_record_invalid_cases ______

self = <resync.tests.test_database_security.TestAuditRecordValidation object at 0x000001FCE2D51450>

    def test_validate_audit_record_invalid_cases(self):
        """Test invalid audit record inputs."""
        invalid_cases = [
            # Missing required fields
            ({"user_query": "test", "action": "TEST"}, "Memory ID is required"),
            ({"id": "test", "action": "TEST"}, "User query is required"),
            ({"id": "test", "user_query": "test", "action": "TEST"}, "Agent response is required"),
            # Invalid data types
            (
                {"id": 123, "user_query": "test", "agent_response": "response", "action": "TEST"},
                "Memory ID must be string",
            ),
            (
                {"id": "test", "user_query": None, "agent_response": "response", "action": "TEST"},
                "User query is required",
            ),
            # Length validation
            (
                {"id": "x" * 256, "user_query": "test", "agent_response": "response", "action": "TEST"},
                "Memory ID too long",
            ),
            (
                {"id": "test", "user_query": "x" * 10001, "agent_response": "response", "action": "TEST"},
                "User query too long",
            ),
            # Dangerous content
            (
                {
                    "id": "test",
                    "user_query": "'; DROP TABLE users; --",
                    "agent_response": "response",
                    "action": "TEST",
                },
                "Dangerous pattern detected",
            ),
        ]
    
        for record, expected_error in invalid_cases:
            with pytest.raises((ValueError, TypeError), match=expected_error):
>               _validate_audit_record(record)

resync\tests\test_database_security.py:418: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

record = {'action': 'TEST', 'user_query': 'test'}

    def _validate_audit_record(record: dict) -> bool:
        """Validate an audit record has required fields.
    
        Args:
            record: Audit record dictionary to validate
    
        Returns:
            True if valid
    
        Raises:
            ValueError: If record is invalid
        """
        required_fields = {"action"}
    
        if not isinstance(record, dict):
            raise ValueError("Audit record must be a dictionary")
    
        missing = required_fields - set(record.keys())
        if missing:
            raise ValueError(f"Missing required fields: {missing}")
    
        if not record.get("action"):
            raise ValueError("Action field cannot be empty")
    
        # Loose validation for id (Memory ID) if present
        if "id" in record:
             if not isinstance(record["id"], str):
                 raise ValueError("Memory ID must be string")
             if len(record["id"]) > 255:
                 raise ValueError("Memory ID too long")
    
        # Loose validation for user_query if present
        if "user_query" in record:
             if not isinstance(record["user_query"], str):
                 raise ValueError("User query must be string")
             if len(record["user_query"]) > 10000:
                 raise ValueError("User query too long")
             if not record["user_query"]:
                 raise ValueError("User query cannot be empty")
    
        # Loose validation for agent_response if present in valid cases
        # The test expects it to be required for the test cases provided
        if "agent_response" not in record and "user_query" in record:
>            raise ValueError("Agent response is required")
E            ValueError: Agent response is required

resync\core\audit_db.py:271: ValueError

During handling of the above exception, another exception occurred:

self = <resync.tests.test_database_security.TestAuditRecordValidation object at 0x000001FCE2D51450>

    def test_validate_audit_record_invalid_cases(self):
        """Test invalid audit record inputs."""
        invalid_cases = [
            # Missing required fields
            ({"user_query": "test", "action": "TEST"}, "Memory ID is required"),
            ({"id": "test", "action": "TEST"}, "User query is required"),
            ({"id": "test", "user_query": "test", "action": "TEST"}, "Agent response is required"),
            # Invalid data types
            (
                {"id": 123, "user_query": "test", "agent_response": "response", "action": "TEST"},
                "Memory ID must be string",
            ),
            (
                {"id": "test", "user_query": None, "agent_response": "response", "action": "TEST"},
                "User query is required",
            ),
            # Length validation
            (
                {"id": "x" * 256, "user_query": "test", "agent_response": "response", "action": "TEST"},
                "Memory ID too long",
            ),
            (
                {"id": "test", "user_query": "x" * 10001, "agent_response": "response", "action": "TEST"},
                "User query too long",
            ),
            # Dangerous content
            (
                {
                    "id": "test",
                    "user_query": "'; DROP TABLE users; --",
                    "agent_response": "response",
                    "action": "TEST",
                },
                "Dangerous pattern detected",
            ),
        ]
    
        for record, expected_error in invalid_cases:
>           with pytest.raises((ValueError, TypeError), match=expected_error):
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AssertionError: Regex pattern did not match.
E            Regex: 'Memory ID is required'
E            Input: 'Agent response is required'

resync\tests\test_database_security.py:417: AssertionError
__________ TestSQLInjectionAttackVectors.test_boolean_based_attacks ___________

self = <resync.tests.test_database_security.TestSQLInjectionAttackVectors object at 0x000001FCE2D51950>

    def test_boolean_based_attacks(self):
        """Test boolean-based SQL injection attacks."""
        boolean_attacks = [
            "' OR '1'='1",
            "' OR 'x'='x",
            "') OR ('1'='1' AND ''='",
            "1' AND (SELECT COUNT(*) FROM users) > 0 --",
        ]
    
        for attack in boolean_attacks:
>           with pytest.raises(DatabaseSecurityError):
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           Failed: DID NOT RAISE <class 'resync.core.database_security.DatabaseSecurityError'>

resync\tests\test_database_security.py:486: Failed
____________________ test_admin_ui_renders_and_serves_css _____________________

    def test_admin_ui_renders_and_serves_css() -> None:
        """Validate that templates render and CSS assets are reachable.
    
        This test has two layers:
        1) Always-run minimal UI check (no external deps) that renders admin.html
           and serves the bundled CSS from /static.
        2) If full runtime dependencies are available (e.g. SQLAlchemy), also
           instantiate the real app and verify the real /admin route.
        """
    
        # ------------------------------------------------------------------
        # Layer 1: Minimal render check (no database/redis required)
        # ------------------------------------------------------------------
        from fastapi import FastAPI
        from fastapi.responses import HTMLResponse
        from fastapi.staticfiles import StaticFiles
        from fastapi.templating import Jinja2Templates
    
        root = _root()
        templates = Jinja2Templates(directory=str(root / "templates"))
        app_min = FastAPI()
        app_min.mount("/static", StaticFiles(directory=str(root / "static")), name="static")
    
        @app_min.get("/admin", response_class=HTMLResponse)
        def admin_page(request: Request):
            return templates.TemplateResponse("admin.html", {"request": request})
    
        with TestClient(app_min) as client:
            admin = client.get("/admin")
            assert admin.status_code == 200
            assert "text/html" in admin.headers.get("content-type", "")
            assert client.get("/static/css/style-neumorphic.css").status_code == 200
            assert client.get("/static/css/admin-neumorphic.css").status_code == 200
    
        # ------------------------------------------------------------------
        # Layer 2: Real app check (only when deps are installed)
        # ------------------------------------------------------------------
        import pytest
    
        pytest.importorskip("sqlalchemy")
    
        from resync.app_factory import ApplicationFactory
    
        app = ApplicationFactory().create_application()
    
        with TestClient(app) as client:
>           r = client.get("/", allow_redirects=False)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'. Did you mean 'follow_redirects'?

resync\tests\test_ui_smoke.py:114: TypeError
---------------------------- Captured stdout call -----------------------------
2026-02-15 06:26:11 [info     ] settings_validation_passed
2026-02-15 06:26:11 [warning  ] templates_directory_not_found  path=D:\Python\GITHUB\resync\6.0\templates
2026-02-15 06:26:11 [info     ] Rate limiting enabled          auth_limit=5/minute default_limit=100/minute storage=memory
2026-02-15 06:26:11 [info     ] middleware_configured
2026-02-15 06:26:11 [info     ] Exception handlers registered successfully
2026-02-15 06:26:11 [info     ] exception_handlers_registered
2026-02-15 06:26:11 [info     ] dependency_injection_configured mode=fastapi_depends
2026-02-15 06:26:11 [info     ] Circuit breaker initialized    failure_threshold=3 name=llm_service recovery_timeout=60
2026-02-15 06:26:12 [info     ] enhanced_endpoints_registered  prefix=/api/v2
2026-02-15 06:26:12 [info     ] graphrag_admin_endpoints_registered prefix=/api/admin/graphrag
2026-02-15 06:26:12 [info     ] document_kg_admin_endpoints_registered prefix=/api/admin/kg
2026-02-15 06:26:12 [info     ] unified_config_endpoints_registered prefix=/api/admin/config
2026-02-15 06:26:12 [warning  ] templates_directory_not_found
2026-02-15 06:26:12 [info     ] monitoring_routers_registered
2026-02-15 06:26:20 [info     ] unified_routers_registered     admin_count=15 monitoring_count=4 other_count=4
2026-02-15 06:26:21 [info     ] routers_registered             count=9
2026-02-15 06:26:21 [warning  ] static_directory_not_found     path=D:\Python\GITHUB\resync\6.0\static
2026-02-15 06:26:21 [info     ] special_endpoints_registered
2026-02-15 06:26:21 [info     ] application_created            debug_mode=False environment=test
2026-02-15 06:26:21 [info     ] application_startup_initiated
2026-02-15 06:26:21 [info     ] teams_webhook_version_loaded   version='v1.0.0-teams-webhook\n2024-12-26'
2026-02-15 06:26:21 [info     ] startup_checks_begin           critical_services=['redis_connection'] max_total_seconds=60.0 strict=False
2026-02-15 06:26:23 [error    ] startup_redis_unexpected_error error_message='Unexpected error during Redis initialization: Error 22 connecting to localhost:6379. O computador remoto recusou a conexÒo de rede.' reason_code=redis_init_error
2026-02-15 06:26:28 [info     ] startup_checks_end             duration_ms=7640 overall_health=False results=[{'name': 'redis_connection', 'status': 'fail', 'critical': True, 'reason_code': 'redis_init_error', 'detail': 'Unexpected error during Redis initialization: Error 22 connecting to localhost:6379. O computador remoto recusou a conexÒo de rede.', 'attempts': 1, 'duration_ms': 2061}, {'name': 'tws_reachability', 'status': 'skipped', 'critical': False, 'reason_code': 'not_configured', 'detail': 'TWS host/port not configured', 'attempts': 1, 'duration_ms': 0}, {'name': 'llm_service', 'status': 'fail', 'critical': False, 'reason_code': 'http_status', 'detail': 'HTTP 404', 'attempts': 3, 'duration_ms': 2781}, {'name': 'rag_service', 'status': 'fail', 'critical': False, 'reason_code': 'request_error:ConnectError', 'detail': 'request_error:ConnectError', 'attempts': 3, 'duration_ms': 5357}]
2026-02-15 06:26:28 [warning  ] startup_health_failed          critical_services=['redis_connection'] results=[{'name': 'redis_connection', 'status': 'fail', 'critical': True, 'reason_code': 'redis_init_error', 'detail': 'Unexpected error during Redis initialization: Error 22 connecting to localhost:6379. O computador remoto recusou a conexÒo de rede.', 'attempts': 1, 'duration_ms': 2061}, {'name': 'tws_reachability', 'status': 'skipped', 'critical': False, 'reason_code': 'not_configured', 'detail': 'TWS host/port not configured', 'attempts': 1, 'duration_ms': 0}, {'name': 'llm_service', 'status': 'fail', 'critical': False, 'reason_code': 'http_status', 'detail': 'HTTP 404', 'attempts': 3, 'duration_ms': 2781}, {'name': 'rag_service', 'status': 'fail', 'critical': False, 'reason_code': 'request_error:ConnectError', 'detail': 'request_error:ConnectError', 'attempts': 3, 'duration_ms': 5357}] strict=False
2026-02-15 06:26:28 [info     ] tws_client_mode                mode=mock
2026-02-15 06:26:28 [info     ] initializing_agent_manager     correlation_id="{'component': 'agent_manager', 'operation': 'init', 'global_correlation': 'core_boot_1771147588_f53aa058', 'environment': {'is_mock': False, 'mock_reason': None, 'boot_id': 'core_boot_1771147588_f53aa058', 'component_count': 0}}_a8ec6c56" has_factory=True native_agent=True
2026-02-15 06:26:28 [info     ] agent_manager_initialized      agents_count=2 correlation_id="{'component': 'agent_manager', 'operation': 'init', 'global_correlation': 'core_boot_1771147588_f53aa058', 'environment': {'is_mock': False, 'mock_reason': None, 'boot_id': 'core_boot_1771147588_f53aa058', 'component_count': 0}}_a8ec6c56" tools_count=2
2026-02-15 06:26:28 [info     ] hybrid_router_initialized      modes=[<RoutingMode.RAG_ONLY: 'rag_only'>, <RoutingMode.AGENTIC: 'agentic'>, <RoutingMode.DIAGNOSTIC: 'diagnostic'>]
2026-02-15 06:26:28 [warning  ] idempotency_manager_degraded_mode hint='Redis unavailable. Idempotent endpoints will return 503.'
2026-02-15 06:26:28 [info     ] Circuit breaker initialized    failure_threshold=5 name=llm recovery_timeout=60
2026-02-15 06:26:29 [info     ] Circuit breaker initialized    failure_threshold=5 name=rag_service recovery_timeout=60
2026-02-15 06:26:29 [info     ] rag_client_initialized         max_concurrency=10 max_retries=3 url=http://localhost:8003
2026-02-15 06:26:31 [info     ] domain_singletons_initialized  singletons=['connection_manager', 'knowledge_graph', 'tws_client', 'agent_manager', 'hybrid_router', 'idempotency_manager', 'llm_service', 'file_ingestor'] tws_mode=mock
2026-02-15 06:26:31 [info     ] tws_monitor_initialized
2026-02-15 06:26:31 [info     ] tws_monitoring_started
2026-02-15 06:26:31 [info     ] core_services_initialized
2026-02-15 06:26:31 [info     ] initializing_proactive_monitoring
2026-02-15 06:26:31 [error    ] proactive_monitoring_initialization_failed error="'State' object has no attribute 'tws_client'"
2026-02-15 06:26:31 [warning  ] cache_warming_failed           error='Redis client not initialized. Ensure RedisInitializer.initialize() runs during application startup (lifespan). To allow lazy init (legacy), set RESYNC_REDIS_LAZY_INIT=1.'
2026-02-15 06:26:31 [warning  ] graphrag_initialization_failed error="No module named 'langchain_core'"
2026-02-15 06:26:31 [info     ] UnifiedConfigManager initialized
2026-02-15 06:26:31 [warning  ] Config file not found: D:\Python\GITHUB\resync\6.0\config\graphrag.toml
2026-02-15 06:26:31 [warning  ] Config file not found: D:\Python\GITHUB\resync\6.0\config\ai.toml
2026-02-15 06:26:31 [warning  ] Config file not found: D:\Python\GITHUB\resync\6.0\config\monitoring.toml
2026-02-15 06:26:31 [warning  ] Config file not found: D:\Python\GITHUB\resync\6.0\config\system.toml
2026-02-15 06:26:31 [warning  ] Config file not found: D:\Python\GITHUB\resync\6.0\config\llm.toml
2026-02-15 06:26:31 [warning  ] Watchdog not installed. Hot reload unavailable.
2026-02-15 06:26:31 [info     ] Configuration system initialized with hot reload
2026-02-15 06:26:31 [info     ] application_startup_completed
2026-02-15 06:26:31 [info     ] application_shutdown_initiated
2026-02-15 06:26:31 [info     ] background_tasks_cancelled
2026-02-15 06:26:31 [info     ] redis_client_closed
2026-02-15 06:26:31 [info     ] rag_client_closed
2026-02-15 06:26:31 [info     ] domain_singletons_shutdown_completed
2026-02-15 06:26:31 [info     ] domain_singletons_shutdown
2026-02-15 06:26:31 [info     ] tws_monitoring_stopped
2026-02-15 06:26:31 [info     ] tws_monitor_shutdown
2026-02-15 06:26:31 [info     ] application_shutdown_completed
------------------------------ Captured log call ------------------------------
WARNING  resync.api.auth.service:service.py:23 AUTH_SECRET_KEY not set ù using insecure default. This is only acceptable in development.
CRITICAL resync.core.redis_init:redis_init.py:297 Unexpected error during Redis initialization
Traceback (most recent call last):
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\connection.py", line 276, in connect
    await self.retry.call_with_retry(
        lambda: self._connect(), lambda error: self.disconnect()
    )
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\connection.py", line 682, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        **self._connection_arguments()
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        lambda: protocol, host, port, **kwds)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\base_events.py", line 1176, in create_connection
    raise exceptions[0]
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\base_events.py", line 1146, in create_connection
    sock = await self._connect_sock(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
        exceptions, addrinfo, laddr_infos)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\base_events.py", line 1045, in _connect_sock
    await self.sock_connect(sock, address)
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\proactor_events.py", line 728, in sock_connect
    return await self._proactor.connect(sock, address)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\windows_events.py", line 804, in _poll
    value = callback(transferred, key, ov)
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\asyncio\windows_events.py", line 600, in finish_connect
    ov.getresult()
    ~~~~~~~~~~~~^^
ConnectionRefusedError: [WinError 1225] O computador remoto recusou a conexÒo de rede

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\Python\GITHUB\resync\6.0\resync\core\redis_init.py", line 221, in initialize
    acquired = await redis_client.set(lock_key, lock_val, nx=True, ex=lock_timeout)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\client.py", line 610, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\connection.py", line 1049, in get_connection
    await self.ensure_connection(connection)
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\connection.py", line 1082, in ensure_connection
    await connection.connect()
  File "C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\redis\asyncio\connection.py", line 284, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 22 connecting to localhost:6379. O computador remoto recusou a conexÒo de rede.
WARNING  resync.services.mock_tws_service:mock_tws_service.py:62 Mock data file not found at D:\Python\GITHUB\resync\6.0\mock_tws_data.json. Returning empty data.
WARNING  resync.knowledge.ingestion.embedding_service:embedding_service.py:244 No API key found for provider openai. Falling back to hash-based embeddings.
ERROR    resync.api.monitoring_dashboard:monitoring_dashboard.py:582 Redis nÒo disponÝvel, encerrando collector: Redis client not initialized. Ensure RedisInitializer.initialize() runs during application startup (lifespan). To allow lazy init (legacy), set RESYNC_REDIS_LAZY_INIT=1.
Traceback (most recent call last):
  File "D:\Python\GITHUB\resync\6.0\resync\api\monitoring_dashboard.py", line 579, in metrics_collector_loop
    redis = get_redis_client()
  File "D:\Python\GITHUB\resync\6.0\resync\core\redis_init.py", line 103, in get_redis_client
    raise RuntimeError(
    ...<3 lines>...
    )
RuntimeError: Redis client not initialized. Ensure RedisInitializer.initialize() runs during application startup (lifespan). To allow lazy init (legacy), set RESYNC_REDIS_LAZY_INIT=1.
_____ test_request_scoped_dependency_is_isolated_under_concurrency[trio] ______

asynclib_name = 'trio'

    def get_async_backend(asynclib_name: str | None = None) -> type[AsyncBackend]:
        if asynclib_name is None:
            asynclib_name = sniffio.current_async_library()
    
        # We use our own dict instead of sys.modules to get the already imported back-end
        # class because the appropriate modules in sys.modules could potentially be only
        # partially initialized
        try:
>           return loaded_backends[asynclib_name]
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           KeyError: 'trio'

C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\anyio\_core\_eventloop.py:162: KeyError

During handling of the above exception, another exception occurred:

pyfuncitem = <Function test_request_scoped_dependency_is_isolated_under_concurrency[trio]>

    @pytest.hookimpl(tryfirst=True)
    def pytest_pyfunc_call(pyfuncitem: Any) -> bool | None:
        def run_with_hypothesis(**kwargs: Any) -> None:
            with get_runner(backend_name, backend_options) as runner:
                runner.run_test(original_func, kwargs)
    
        backend = pyfuncitem.funcargs.get("anyio_backend")
        if backend:
            backend_name, backend_options = extract_backend_and_options(backend)
    
            if hasattr(pyfuncitem.obj, "hypothesis"):
                # Wrap the inner test function unless it's already wrapped
                original_func = pyfuncitem.obj.hypothesis.inner_test
                if original_func.__qualname__ != run_with_hypothesis.__qualname__:
                    if iscoroutinefunction(original_func):
                        pyfuncitem.obj.hypothesis.inner_test = run_with_hypothesis
    
                return None
    
            if iscoroutinefunction(pyfuncitem.obj):
                funcargs = pyfuncitem.funcargs
                testargs = {arg: funcargs[arg] for arg in pyfuncitem._fixtureinfo.argnames}
>               with get_runner(backend_name, backend_options) as runner:
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\anyio\pytest_plugin.py:184: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\contextlib.py:141: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\anyio\pytest_plugin.py:43: in get_runner
    asynclib = get_async_backend(backend_name)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\anyio\_core\_eventloop.py:164: in get_async_backend
    module = import_module(f"anyio._backends._{asynclib_name}")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\importlib\__init__.py:88: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    
    import array
    import math
    import os
    import socket
    import sys
    import types
    import weakref
    from collections.abc import (
        AsyncGenerator,
        AsyncIterator,
        Awaitable,
        Callable,
        Collection,
        Coroutine,
        Iterable,
        Sequence,
    )
    from concurrent.futures import Future
    from contextlib import AbstractContextManager
    from dataclasses import dataclass
    from functools import partial
    from io import IOBase
    from os import PathLike
    from signal import Signals
    from socket import AddressFamily, SocketKind
    from types import TracebackType
    from typing import (
        IO,
        TYPE_CHECKING,
        Any,
        Generic,
        NoReturn,
        TypeVar,
        cast,
        overload,
    )
    
>   import trio.from_thread
E   ModuleNotFoundError: No module named 'trio'

C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\anyio\_backends\_trio.py:40: ModuleNotFoundError
============================== warnings summary ===============================
resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\starlette\templating.py:162: DeprecationWarning: The `name` is not the first parameter anymore. The first parameter should be the `Request` instance.
  Replace `TemplateResponse(name, {"request": request})` by `TemplateResponse(request, name)`.
    warnings.warn(

resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_generate_schema.py:298: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.11/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(

resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  D:\Python\GITHUB\resync\6.0\resync\core\database\models\teams.py:8: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  D:\Python\GITHUB\resync\6.0\resync\api\health.py:10: DeprecationWarning: Importing 'get_health_check_service' from 'resync.core.health' is deprecated. Use 'get_unified_health_service' instead.
    from resync.core.health import (

resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  D:\Python\GITHUB\resync\6.0\resync\api\routes\monitoring\dashboard.py:462: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @router.on_event("startup")

resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  D:\Python\GITHUB\resync\6.0\resync\core\database\models\teams_notifications.py:8: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css
  D:\Python\GITHUB\resync\6.0\resync\api\routes\core\health.py:621: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @router.on_event("shutdown")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED resync/tests/test_database_security.py::TestDatabaseInputValidator::test_validate_string_input_invalid_cases
FAILED resync/tests/test_database_security.py::TestSQLInjectionMiddleware::test_sql_injection_detection_patterns
FAILED resync/tests/test_database_security.py::TestAuditRecordValidation::test_validate_audit_record_valid_cases
FAILED resync/tests/test_database_security.py::TestAuditRecordValidation::test_validate_audit_record_invalid_cases
FAILED resync/tests/test_database_security.py::TestSQLInjectionAttackVectors::test_boolean_based_attacks
FAILED resync/tests/test_ui_smoke.py::test_admin_ui_renders_and_serves_css - ...
FAILED resync/tests/test_request_scope_isolation.py::test_request_scoped_dependency_is_isolated_under_concurrency[trio]
================== 7 failed, 28 passed, 8 warnings in 21.78s ==================
