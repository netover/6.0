<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resync - Configurações do Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/admin-neumorphic.css" rel="stylesheet">
    <style>
        .settings-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .stat-box {
            background: var(--neuro-bg-secondary);
            box-shadow: var(--shadow-sm);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            text-align: center;
            min-width: 100px;
        }
        
        .stat-box .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--neuro-primary);
        }
        
        .stat-box .stat-label {
            font-size: 0.75rem;
            color: var(--neuro-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setting-group {
            background: var(--neuro-bg-primary);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-inset-sm);
            transition: all 0.2s ease;
        }
        
        .setting-group:hover {
            box-shadow: var(--shadow-inset);
        }
        
        .setting-group.modified {
            border-left: 4px solid var(--neuro-warning);
        }
        
        .setting-group.requires-restart {
            border-right: 3px solid var(--neuro-info);
        }
        
        .setting-label {
            font-weight: 600;
            color: var(--neuro-text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .setting-label .badge {
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .restart-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.5rem;
            background: var(--neuro-info);
            color: white;
            border-radius: 4px;
            font-size: 0.65rem;
            cursor: help;
        }
        
        .restart-indicator i {
            font-size: 0.6rem;
        }
        
        .hot-reload-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.5rem;
            background: var(--neuro-success);
            color: white;
            border-radius: 4px;
            font-size: 0.65rem;
        }
        
        .form-control, .form-select {
            background: var(--neuro-bg-secondary);
            border: none;
            border-radius: 10px;
            box-shadow: var(--shadow-inset-sm);
            padding: 0.625rem 1rem;
            color: var(--neuro-text-primary);
        }
        
        .form-control:focus, .form-select:focus {
            background: var(--neuro-bg-secondary);
            box-shadow: var(--shadow-inset), 0 0 0 2px var(--neuro-primary);
            color: var(--neuro-text-primary);
        }
        
        .form-check-input {
            background: var(--neuro-bg-primary);
            border: none;
            box-shadow: var(--shadow-inset-sm);
        }
        
        .form-check-input:checked {
            background: var(--neuro-gradient);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-neuro {
            background: var(--neuro-bg-secondary);
            border: none;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            color: var(--neuro-text-primary);
            padding: 0.625rem 1.25rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-neuro:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            color: var(--neuro-primary);
        }
        
        .btn-neuro:active {
            box-shadow: var(--shadow-inset);
            transform: translateY(0);
        }
        
        .btn-neuro-primary {
            background: var(--neuro-gradient);
            color: white;
        }
        
        .btn-neuro-primary:hover {
            color: white;
            opacity: 0.9;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neuro-text-muted);
        }
        
        .search-box input {
            padding-left: 2.5rem;
        }
        
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }
        
        .toast {
            background: var(--neuro-bg-secondary);
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }
        
        .toast.success { border-left: 4px solid var(--neuro-success); }
        .toast.error { border-left: 4px solid var(--neuro-danger); }
        .toast.warning { border-left: 4px solid var(--neuro-warning); }
        .toast.info { border-left: 4px solid var(--neuro-info); }
        
        .action-buttons {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 0.75rem;
            z-index: 1000;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(224, 229, 236, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .spinner-neuro {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--neuro-bg-secondary);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spinner-neuro::after {
            content: '';
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--neuro-primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--neuro-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
        
        /* Tooltip customizado */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--neuro-text-primary);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            max-width: 300px;
            white-space: normal;
            text-align: center;
        }
        
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--neuro-text-primary);
            margin-bottom: -5px;
            z-index: 1000;
        }
        
        /* Restart summary modal */
        .restart-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .restart-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--neuro-bg-primary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .restart-list-item .key {
            font-weight: 600;
            color: var(--neuro-primary);
        }
        
        .restart-list-item .reason {
            font-size: 0.8rem;
            color: var(--neuro-text-muted);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-neuro"></div>
            <p class="mt-3" style="color: var(--neuro-text-muted);">Carregando configurações...</p>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Header -->
    <header class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <a href="/admin" class="btn btn-neuro me-3" title="Voltar para Admin">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div>
                            <h1><i class="fas fa-sliders-h me-2"></i>Configurações do Sistema</h1>
                            <p>Gerencie todas as configurações do Resync</p>
                        </div>
                    </div>
                    
                    <div class="settings-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalSections">-</div>
                            <div class="stat-label">Seções</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalFields">-</div>
                            <div class="stat-label">Configurações</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="modifiedCount">0</div>
                            <div class="stat-label">Modificadas</div>
                        </div>
                        <div class="stat-box" title="Configurações que serão aplicadas imediatamente">
                            <div class="stat-value" id="hotReloadCount">-</div>
                            <div class="stat-label">Hot-Reload</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end mt-3 mt-md-0">
                    <div class="btn-group">
                        <button class="btn btn-neuro" id="exportBtn" title="Exportar configurações">
                            <i class="fas fa-download me-2"></i>Exportar
                        </button>
                        <button class="btn btn-neuro" id="importBtn" title="Importar configurações">
                            <i class="fas fa-upload me-2"></i>Importar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 col-md-4 mb-4">
                <div class="sidebar">
                    <div class="search-box mb-3">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="searchSettings" placeholder="Buscar configuração...">
                    </div>
                    
                    <!-- Legend -->
                    <div class="mb-3 px-2">
                        <small class="text-muted d-block mb-2">Legenda:</small>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="hot-reload-indicator"><i class="fas fa-bolt"></i> Hot-Reload</span>
                            <span class="restart-indicator"><i class="fas fa-redo"></i> Requer Restart</span>
                        </div>
                    </div>
                    
                    <nav id="sectionNav" class="nav flex-column">
                        <!-- Populated by JavaScript -->
                    </nav>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="col-lg-9 col-md-8">
                <div id="settingsContainer">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-neuro" id="resetAllBtn" title="Resetar para padrão">
            <i class="fas fa-undo"></i>
        </button>
        <button class="btn btn-neuro-primary btn-lg" id="saveAllBtn">
            <i class="fas fa-save me-2"></i>Salvar Alterações
        </button>
    </div>
    
    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--neuro-bg-secondary); border: none; border-radius: 16px; box-shadow: var(--shadow-md);">
                <div class="modal-header" style="border: none;">
                    <h5 class="modal-title"><i class="fas fa-upload me-2" style="color: var(--neuro-primary);"></i>Importar Configurações</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Selecione o arquivo JSON</label>
                        <input type="file" class="form-control" id="importFile" accept=".json">
                    </div>
                    <div class="alert" style="background: var(--neuro-bg-primary); border: none; border-radius: 10px; box-shadow: var(--shadow-inset-sm);">
                        <i class="fas fa-exclamation-triangle me-2" style="color: var(--neuro-warning);"></i>
                        A importação irá sobrescrever as configurações atuais.
                    </div>
                </div>
                <div class="modal-footer" style="border: none;">
                    <button type="button" class="btn btn-neuro" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-neuro-primary" id="confirmImport">Importar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Restart Required Modal -->
    <div class="modal fade" id="restartModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--neuro-bg-secondary); border: none; border-radius: 16px; box-shadow: var(--shadow-md);">
                <div class="modal-header" style="border: none;">
                    <h5 class="modal-title"><i class="fas fa-redo me-2" style="color: var(--neuro-info);"></i>Restart Necessário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Algumas configurações requerem restart da aplicação para entrar em vigor:</p>
                    <div class="restart-list" id="restartList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer" style="border: none;">
                    <button type="button" class="btn btn-neuro" data-bs-dismiss="modal">Entendi</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let settingsData = null;
        let pendingChanges = {};
        const API_BASE = '/api/v1/admin/settings';
        
        // Auth header
        function getAuthHeader() {
            let creds = localStorage.getItem('adminCredentials');
            if (!creds) {
                const username = prompt('Admin Username:');
                const password = prompt('Admin Password:');
                creds = btoa(`${username}:${password}`);
                localStorage.setItem('adminCredentials', creds);
            }
            return { 'Authorization': `Basic ${creds}` };
        }
        
        // Toast notification
        function showToast(message, type = 'success') {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.innerHTML = `
                <div class="toast-body d-flex align-items-center p-3">
                    <i class="fas fa-${icons[type] || icons.info} me-2" 
                       style="color: var(--neuro-${type === 'error' ? 'danger' : type});"></i>
                    ${message}
                </div>
            `;
            document.querySelector('.toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        
        // Load all settings
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/all`, {
                    headers: getAuthHeader()
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('adminCredentials');
                    location.reload();
                    return;
                }
                
                settingsData = await response.json();
                renderNavigation();
                renderSettings();
                updateStats();
                document.getElementById('loadingOverlay').classList.add('hidden');
            } catch (error) {
                console.error('Failed to load settings:', error);
                showToast('Erro ao carregar configurações', 'error');
            }
        }
        
        // Count hot-reload vs restart settings
        function countHotReload() {
            let hotReload = 0;
            let requiresRestart = 0;
            
            Object.values(settingsData.schema).forEach(section => {
                Object.values(section.fields).forEach(field => {
                    if (field.readonly) return;
                    if (field.hot_reload === false) {
                        requiresRestart++;
                    } else {
                        hotReload++;
                    }
                });
            });
            
            return { hotReload, requiresRestart };
        }
        
        // Render navigation
        function renderNavigation() {
            const nav = document.getElementById('sectionNav');
            nav.innerHTML = '';
            
            let currentCategory = '';
            const categories = {
                'application': 'GERAL',
                'server': 'GERAL',
                'database': 'INFRAESTRUTURA',
                'redis': 'INFRAESTRUTURA',
                'llm': 'AI & LLM',
                'ollama': 'AI & LLM',
                'langfuse': 'AI & LLM',
                'langgraph': 'AI & LLM',
                'tws': 'TWS',
                'tws_monitoring': 'TWS',
                'tws_retention': 'TWS',
                'tws_notifications': 'TWS',
                'tws_dashboard': 'TWS',
                'hybrid_retriever': 'RAG & BUSCA',
                'cache': 'PERFORMANCE',
                'security': 'SEGURANÇA',
                'rate_limiting': 'SEGURANÇA',
                'compression': 'PERFORMANCE',
                'cors': 'SEGURANÇA',
                'uploads': 'ARQUIVOS',
                'backup': 'ARQUIVOS',
                'rag_service': 'RAG & BUSCA',
                'enterprise': 'ENTERPRISE',
            };
            
            Object.entries(settingsData.schema).forEach(([key, section], index) => {
                const cat = categories[key] || 'OUTROS';
                if (cat !== currentCategory) {
                    currentCategory = cat;
                    const header = document.createElement('h6');
                    header.textContent = cat;
                    nav.appendChild(header);
                }
                
                const link = document.createElement('a');
                link.className = `nav-link ${index === 0 ? 'active' : ''}`;
                link.href = `#section-${key}`;
                link.dataset.section = key;
                link.innerHTML = `
                    <i class="fas ${section.icon}"></i>
                    <span>${section.title}</span>
                `;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#sectionNav .nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(`section-${key}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                nav.appendChild(link);
            });
        }
        
        // Render settings
        function renderSettings() {
            const container = document.getElementById('settingsContainer');
            container.innerHTML = '';
            
            Object.entries(settingsData.schema).forEach(([sectionKey, section]) => {
                const values = settingsData.values[sectionKey] || {};
                
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `section-${sectionKey}`;
                
                card.innerHTML = `
                    <div class="card-header d-flex align-items-center">
                        <div class="section-icon">
                            <i class="fas ${section.icon}"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">${section.title}</h5>
                            <small style="color: var(--neuro-text-muted);">${section.description}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        ${Object.entries(section.fields).map(([fieldKey, field]) => {
                            const value = values[fieldKey];
                            return renderField(fieldKey, field, value);
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Add event listeners
            container.querySelectorAll('.setting-input').forEach(input => {
                input.addEventListener('change', handleInputChange);
            });
        }
        
        // Render individual field
        function renderField(key, config, value) {
            const readonly = config.readonly ? 'disabled' : '';
            const hotReload = config.hot_reload !== false;
            const restartReason = config.restart_reason || 'Requer restart da aplicação';
            
            const warning = config.warning ? `<span class="badge" style="background: var(--neuro-warning); color: white;">${config.warning}</span>` : '';
            const readonlyBadge = config.readonly ? '<span class="badge" style="background: var(--neuro-text-muted); color: white;">Somente Leitura</span>' : '';
            
            // Hot-reload or restart indicator
            let reloadIndicator = '';
            if (!config.readonly) {
                if (hotReload) {
                    reloadIndicator = '<span class="hot-reload-indicator"><i class="fas fa-bolt"></i> Hot-Reload</span>';
                } else {
                    reloadIndicator = `<span class="restart-indicator" data-tooltip="${restartReason}"><i class="fas fa-redo"></i> Restart</span>`;
                }
            }
            
            let inputHtml = '';
            
            switch (config.type) {
                case 'boolean':
                    inputHtml = `
                        <div class="form-check form-switch">
                            <input class="form-check-input setting-input" type="checkbox" 
                                   id="${key}" data-key="${key}" data-hot-reload="${hotReload}"
                                   ${value ? 'checked' : ''} ${readonly}>
                            <label class="form-check-label" for="${key}" style="color: var(--neuro-text-secondary);">
                                ${value ? 'Ativado' : 'Desativado'}
                            </label>
                        </div>
                    `;
                    break;
                    
                case 'select':
                    inputHtml = `
                        <select class="form-select setting-input" id="${key}" data-key="${key}" data-hot-reload="${hotReload}" ${readonly}>
                            ${config.options.map(opt => `
                                <option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>
                            `).join('')}
                        </select>
                    `;
                    break;
                    
                case 'number':
                    inputHtml = `
                        <input type="number" class="form-control setting-input" id="${key}" data-key="${key}" data-hot-reload="${hotReload}"
                               value="${value ?? ''}" 
                               ${config.min !== undefined ? `min="${config.min}"` : ''}
                               ${config.max !== undefined ? `max="${config.max}"` : ''}
                               ${config.step !== undefined ? `step="${config.step}"` : ''}
                               ${readonly}>
                    `;
                    break;
                    
                default:
                    inputHtml = `
                        <input type="text" class="form-control setting-input" id="${key}" data-key="${key}" data-hot-reload="${hotReload}"
                               value="${value ?? ''}" 
                               ${config.placeholder ? `placeholder="${config.placeholder}"` : ''}
                               ${readonly}>
                    `;
            }
            
            return `
                <div class="setting-group ${!hotReload && !config.readonly ? 'requires-restart' : ''}" data-key="${key}">
                    <div class="setting-label">
                        ${config.label}
                        ${warning}
                        ${readonlyBadge}
                        ${reloadIndicator}
                    </div>
                    ${inputHtml}
                </div>
            `;
        }
        
        // Handle input change
        function handleInputChange(e) {
            const key = e.target.dataset.key;
            let value;
            
            if (e.target.type === 'checkbox') {
                value = e.target.checked;
                e.target.nextElementSibling.textContent = value ? 'Ativado' : 'Desativado';
            } else if (e.target.type === 'number') {
                value = parseFloat(e.target.value);
            } else {
                value = e.target.value;
            }
            
            pendingChanges[key] = value;
            updateStats();
            
            // Visual indicator
            e.target.closest('.setting-group').classList.add('modified');
        }
        
        // Update stats
        function updateStats() {
            const counts = countHotReload();
            document.getElementById('totalSections').textContent = Object.keys(settingsData.schema).length;
            document.getElementById('totalFields').textContent = Object.values(settingsData.schema)
                .reduce((sum, s) => sum + Object.keys(s.fields).length, 0);
            document.getElementById('modifiedCount').textContent = Object.keys(pendingChanges).length;
            document.getElementById('hotReloadCount').textContent = counts.hotReload;
        }
        
        // Save all changes
        async function saveAllChanges() {
            if (Object.keys(pendingChanges).length === 0) {
                showToast('Nenhuma alteração para salvar', 'info');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/bulk-update`, {
                    method: 'PUT',
                    headers: {
                        ...getAuthHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ settings: pendingChanges })
                });
                
                const result = await response.json();
                
                if (result.success || result.updated_count > 0) {
                    // Show success message
                    if (result.hot_reloaded_count > 0) {
                        showToast(`${result.hot_reloaded_count} configurações aplicadas imediatamente!`, 'success');
                    }
                    
                    // Show restart modal if needed
                    if (result.requires_restart && result.requires_restart.length > 0) {
                        showRestartModal(result.requires_restart);
                    }
                    
                    pendingChanges = {};
                    loadSettings();
                } else {
                    showToast(`Erro: ${result.errors.join(', ')}`, 'error');
                }
            } catch (error) {
                showToast('Erro ao salvar configurações', 'error');
            }
        }
        
        // Show restart required modal
        function showRestartModal(requiresRestart) {
            const list = document.getElementById('restartList');
            list.innerHTML = requiresRestart.map(item => `
                <div class="restart-list-item">
                    <div>
                        <div class="key">${item.key}</div>
                        <div class="reason">${item.reason}</div>
                    </div>
                    <i class="fas fa-redo" style="color: var(--neuro-info);"></i>
                </div>
            `).join('');
            
            new bootstrap.Modal(document.getElementById('restartModal')).show();
        }
        
        // Export settings
        async function exportSettings() {
            try {
                const response = await fetch(`${API_BASE}/export`, {
                    headers: getAuthHeader()
                });
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `resync-settings-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Configurações exportadas!', 'success');
            } catch (error) {
                showToast('Erro ao exportar', 'error');
            }
        }
        
        // Import settings
        async function importSettings(file) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                const response = await fetch(`${API_BASE}/import`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`${result.imported_count} configurações importadas!`, 'success');
                    loadSettings();
                } else {
                    showToast('Erro na importação', 'error');
                }
            } catch (error) {
                showToast('Erro ao importar: arquivo inválido', 'error');
            }
        }
        
        // Reset all settings
        async function resetAllSettings() {
            if (!confirm('Tem certeza que deseja resetar TODAS as configurações para os valores padrão?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reset-all`, {
                    method: 'DELETE',
                    headers: getAuthHeader()
                });
                
                const result = await response.json();
                showToast(`${result.reset_count} configurações resetadas!`, 'success');
                pendingChanges = {};
                loadSettings();
            } catch (error) {
                showToast('Erro ao resetar', 'error');
            }
        }
        
        // Search functionality
        function filterSettings(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('.setting-group').forEach(group => {
                const key = group.dataset.key.toLowerCase();
                const label = group.querySelector('.setting-label').textContent.toLowerCase();
                const visible = key.includes(q) || label.includes(q) || !q;
                group.style.display = visible ? '' : 'none';
            });
        }
        
        // Event listeners
        document.getElementById('saveAllBtn').addEventListener('click', saveAllChanges);
        document.getElementById('exportBtn').addEventListener('click', exportSettings);
        document.getElementById('resetAllBtn').addEventListener('click', resetAllSettings);
        document.getElementById('searchSettings').addEventListener('input', (e) => filterSettings(e.target.value));
        
        document.getElementById('importBtn').addEventListener('click', () => {
            new bootstrap.Modal(document.getElementById('importModal')).show();
        });
        
        document.getElementById('confirmImport').addEventListener('click', () => {
            const file = document.getElementById('importFile').files[0];
            if (file) {
                importSettings(file);
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveAllChanges();
            }
        });
        
        // Initialize
        loadSettings();
    </script>
</body>
</html>
