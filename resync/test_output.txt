============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\User\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: D:\Python\GITHUB\resync\6.0\resync
configfile: pyproject.toml
plugins: anyio-4.11.0, hypothesis-6.140.2, locust-2.41.2, asyncio-1.2.0, benchmark-5.1.0, cov-7.0.0, mock-3.15.1, timeout-2.4.0, xdist-3.8.0, respx-0.22.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

resync/tests/test_startup_timeout.py::test_startup_timeout_triggered PASSED [ 33%]
resync/tests/test_startup_timeout.py::test_startup_success_within_time PASSED [ 66%]
resync/tests/test_startup_timeout.py::test_individual_helper_timeout FAILED [100%]

================================== FAILURES ===================================
_______________________ test_individual_helper_timeout ________________________

self = <resync.core.unified_config.UnifiedConfigManager object at 0x0000027C664B5550>
config_name = 'graphrag'
new_config = {'graphrag': {'budget': {'max_discoveries_per_day': 5, 'max_discoveries_per_hour': 2}, 'cache': {'ttl_days': 90}, 'critical_jobs': {'jobs': ['PAYROLL_NIGHTLY', 'BACKUP_DB', 'ETL_CUSTOMER', 'REPORT_SALES']}, 'enabled': True, ...}}

    async def _apply_config_changes(self, config_name: str, new_config: dict):
        """Apply configuration changes to runtime objects."""
        try:
            if config_name == "graphrag":
>               self._apply_graphrag_config(new_config)

resync\core\unified_config.py:263: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
resync\core\unified_config.py:283: in _apply_graphrag_config
    from resync.core.event_driven_discovery import DiscoveryConfig
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    """
    Event-Driven Auto-Discovery for Knowledge Graph
    
    Automatically discovers job relationships, dependencies, and error patterns
    from TWS logs using LLM extraction. Runs in background without blocking users.
    
    Author: Resync Team
    Version: 5.9.9
    """
    
    import asyncio
    from resync.core.task_tracker import create_tracked_task
    import json
    from datetime import datetime, timezone
    from typing import Any
    
    import structlog
>   from langchain_core.prompts import PromptTemplate
E   ModuleNotFoundError: No module named 'langchain_core'

resync\core\event_driven_discovery.py:18: ModuleNotFoundError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_individual_helper_timeout():
        """Verify that an individual helper's timeout doesn't crash the whole startup."""
        factory = ApplicationFactory()
        app = FastAPI()
    
        async def slow_collector():
            await asyncio.sleep(0.5)
    
        with patch("resync.app_factory.settings") as mock_settings:
            mock_settings.startup_timeout = 5.0
    
            with patch("resync.core.startup.run_startup_checks", AsyncMock(return_value={"overall_health": True})):
                with patch("resync.core.wiring.init_domain_singletons"):
                    with patch("resync.app_factory.enterprise_state_from_app", return_value=MagicMock()):
                        with patch("resync.core.tws_monitor.get_tws_monitor", AsyncMock()):
                            with patch("resync.api_gateway.container.setup_dependencies"):
                                # We want to trigger the TimeoutError inside _init_metrics_collector
                                # It has a 10s timeout. We'll wrap the call to make it shorter.
    
                                # Mock the task creator to be slow
                                async def very_slow_task(*args, **kwargs):
                                    await asyncio.sleep(0.5)
                                    return MagicMock()
    
                                with patch("resync.core.task_tracker.create_tracked_task", side_effect=very_slow_task):
                                    # We need to mock asyncio.timeout to return a short timeout when it's called with 10
                                    original_timeout = asyncio.timeout
                                    def mock_timeout(seconds):
                                        if seconds == 10:
                                            return original_timeout(0.1)
                                        return original_timeout(seconds)
    
                                    with patch("asyncio.timeout", side_effect=mock_timeout):
                                        # Should complete without raising TimeoutError to the top
>                                       async with factory.lifespan(app):
                                                   ^^^^^^^^^^^^^^^^^^^^^

resync\tests\test_startup_timeout.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\contextlib.py:214: in __aenter__
    return await anext(self.gen)
           ^^^^^^^^^^^^^^^^^^^^^
resync\app_factory.py:218: in lifespan
    raise result
resync\app_factory.py:466: in _init_config_system
    await initialize_config_system()
resync\core\unified_config.py:463: in initialize_config_system
    await manager.load_all_configs()
resync\core\unified_config.py:194: in load_all_configs
    await self.reload_config_file(path)
resync\core\unified_config.py:236: in reload_config_file
    await self._apply_config_changes(config_name, new_config)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <resync.core.unified_config.UnifiedConfigManager object at 0x0000027C664B5550>
config_name = 'graphrag'
new_config = {'graphrag': {'budget': {'max_discoveries_per_day': 5, 'max_discoveries_per_hour': 2}, 'cache': {'ttl_days': 90}, 'critical_jobs': {'jobs': ['PAYROLL_NIGHTLY', 'BACKUP_DB', 'ETL_CUSTOMER', 'REPORT_SALES']}, 'enabled': True, ...}}

    async def _apply_config_changes(self, config_name: str, new_config: dict):
        """Apply configuration changes to runtime objects."""
        try:
            if config_name == "graphrag":
                self._apply_graphrag_config(new_config)
            elif config_name == "ai":
                self._apply_ai_config(new_config)
            elif config_name == "monitoring":
                self._apply_monitoring_config(new_config)
            elif config_name == "system":
                self._apply_system_config(new_config)
            elif config_name == "llm":
                self._apply_llm_config(new_config)
    
            logger.info("Config changes applied: %s", config_name)
    
        except Exception as e:
            # Re-raise programming errors Ã¹ these are bugs, not runtime failures
            if isinstance(e, (TypeError, KeyError, AttributeError, IndexError)):
                raise
>           logger.error("Failed to apply config changes for %s: %s", config_name, e, exc_info=True)
E           TypeError: _ShimLogger.error() takes 2 positional arguments but 4 were given

resync\core\unified_config.py:279: TypeError
------------------------------ Captured log call ------------------------------
ERROR    resync.core.monitoring_integration:__init__.py:52 proactive_monitoring_initialization_failed
WARNING  resync.app_factory:__init__.py:52 cache_warming_failed
Traceback (most recent call last):
  File "D:\Python\GITHUB\resync\6.0\resync\resync\app_factory.py", line 381, in _init_cache_warming
    await warmup_cache_on_startup()
  File "D:\Python\GITHUB\resync\6.0\resync\resync\core\cache_utils.py", line 297, in warmup_cache_on_startup
    cache_manager = get_cache_manager()
  File "D:\Python\GITHUB\resync\6.0\resync\resync\core\cache_utils.py", line 282, in get_cache_manager
    _cache_manager = EnhancedCacheManager()
  File "D:\Python\GITHUB\resync\6.0\resync\resync\core\cache_utils.py", line 84, in __init__
    self.redis = get_redis_client()
                 ~~~~~~~~~~~~~~~~^^
  File "D:\Python\GITHUB\resync\6.0\resync\resync\core\redis_init.py", line 103, in get_redis_client
    raise RuntimeError(
    ...<3 lines>...
    )
RuntimeError: Redis client not initialized. Ensure RedisInitializer.initialize() runs during application startup (lifespan). To allow lazy init (legacy), set RESYNC_REDIS_LAZY_INIT=1.
WARNING  resync.app_factory:__init__.py:52 metrics_collector_start_timeout
CRITICAL resync.app_factory:__init__.py:52 critical_startup_programming_error
CRITICAL resync.app_factory:__init__.py:52 application_startup_failed
ERROR    resync.app_factory:__init__.py:52 domain_singletons_shutdown_error
============================== warnings summary ===============================
resync/tests/test_startup_timeout.py::test_startup_timeout_triggered
  C:\Users\User\AppData\Local\Programs\Python\Python313\Lib\importlib\__init__.py:88: DeprecationWarning: Importing from 'resync.core.health.health_service' is deprecated. Use 'resync.core.health.unified_health_service' or 'resync.core.health.health_service_facade' instead. This module will be removed in v7.0.0.
    return _bootstrap._gcd_import(name[level:], package, level)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED resync/tests/test_startup_timeout.py::test_individual_helper_timeout
=================== 1 failed, 2 passed, 1 warning in 1.28s ====================
<sys>:0: RuntimeWarning: coroutine 'metrics_collector_loop' was never awaited
